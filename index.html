<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°å°æ¼‚æµç“¶ï¼ˆroveråˆ¶ä½œï¼‰</title>
    <style>
/*
 *                                        _ooOoo_
 *                                       o8888888o
 *                                       88" . "88
 *                                       (| -_- |)
 *                                        O\ = /O
 *                                    ____/`---'\____
 *                                  .   ' \\| |// `.
 *                                   / \\||| : |||// \
 *                                 / _||||| -:- |||||- \
 *                                   | | \\\ - /// | |
 *                                 | \_| ''\---/'' | |
 *                                  \ .-\__ `-` ___/-. /
 *                               ___`. .' /--.--\ `. . __
 *                            ."" '< `.___\_<|>_/___.' >'"".
 *                           | | : `- \`.;`\ _ /`;.`/ - ` : | |
 *                             \ \ `-. \_ __\ /__ _/ .-` / /
 *                     ======`-.____`-.___\_____/___.-`____.-'======
 *                                        `=---='
 *
 *                     .............................................
 *                              ä½›ç¥–ä¿ä½‘             æ°¸æ— BUG
 */
 /*
 *                                        _ooOoo_
 *                                       o8888888o
 *                                       88" . "88
 *                                       (| -_- |)
 *                                        O\ = /O
 *                                    ____/`---'\____
 *                                  .   ' \\| |// `.
 *                                   / \\||| : |||// \
 *                                 / _||||| -:- |||||- \
 *                                   | | \\\ - /// | |
 *                                 | \_| ''\---/'' | |
 *                                  \ .-\__ `-` ___/-. /
 *                               ___`. .' /--.--\ `. . __
 *                            ."" '< `.___\_<|>_/___.' >'"".
 *                           | | : `- \`.;`\ _ /`;.`/ - ` : | |
 *                             \ \ `-. \_ __\ /__ _/ .-` / /
 *                     ======`-.____`-.___\_____/___.-`____.-'======
 *                                        `=---='
 *
 *                     .............................................
 *                              ä½›ç¥–ä¿ä½‘             æ°¸æ— BUG
 */
 /*å¢å°å¤©ä¸è¦å·æˆ‘ä»£ç ï¼*/
 /*ç‰ˆæƒç”³æ˜ï¼šç”±roveré›†å›¢å¼€å‘*/
        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background: linear-gradient(to bottom, #aee1f9 0%, #f9f9f9 100%);
            font-family: 'Segoe UI', 'Microsoft YaHei', Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .container {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2);
            padding: 40px 30px 30px 30px;
            max-width: 400px;
            width: 90%;
            position: relative;
        }
        .bottle-img {
            width: 120px;
            display: block;
            margin: 0 auto 20px auto;
        }
        h1 {
            text-align: center;
            color: #2a5d84;
            margin-bottom: 20px;
        }
        textarea {
            width: 100%;
            min-height: 100px;
            border-radius: 10px;
            border: 1px solid #b3d7e6;
            padding: 10px;
            font-size: 16px;
            resize: vertical;
            margin-bottom: 18px;
        }
        label {
            font-size: 15px;
            color: #2a5d84;
        }
        .time-select {
            width: 100%;
            margin-bottom: 18px;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #b3d7e6;
            font-size: 15px;
        }
        .custom-time {
            display: none;
            margin-top: 8px;
        }
        .send-btn {
            width: 100%;
            background: #2a5d84;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 12px;
            font-size: 17px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .send-btn:hover {
            background: #1b3c54;
        }
        .success-message {
            color: #2a5d84;
            text-align: center;
            margin-top: 18px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <!-- ç™»å½•æ³¨å†ŒæŒ‰é’® -->
    <div style="position:fixed;top:24px;right:32px;z-index:1000;">
        <button id="loginBtn" style="margin-right:10px;padding:8px 18px;border-radius:8px;border:none;background:#6bb6ff;color:#fff;cursor:pointer;font-size:15px;">ç™»å½•</button>
        <button id="registerBtn" style="padding:8px 18px;border-radius:8px;border:none;background:#2a5d84;color:#fff;cursor:pointer;font-size:15px;">æ³¨å†Œ</button>
    </div>
    <!-- ç™»å½•å¼¹çª— -->
    <div id="loginModal" style="display:none;position:fixed;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);z-index:2000;align-items:center;justify-content:center;">
        <div style="background:#fff;border-radius:16px;max-width:320px;width:90vw;padding:24px;box-shadow:0 4px 24px #0002;position:relative;">
            <button type="button" aria-label="å…³é—­" onclick="document.getElementById('loginModal').style.display='none'" style="position:absolute;right:16px;top:8px;cursor:pointer;font-size:20px;background:none;border:none;">Ã—</button>
            <h2 style="text-align:center;color:#2a5d84;margin-bottom:18px;">ç™»å½•</h2>
            <input type="text" id="loginUser" placeholder="ç”¨æˆ·å/é‚®ç®±" style="width:100%;margin-bottom:12px;padding:8px;border-radius:8px;border:1px solid #b3d7e6;font-size:15px;">
            <input type="password" id="loginPass" placeholder="å¯†ç " style="width:100%;margin-bottom:18px;padding:8px;border-radius:8px;border:1px solid #b3d7e6;font-size:15px;">
            <button id="loginSubmit" style="width:100%;background:#2a5d84;color:#fff;border:none;border-radius:8px;padding:10px;font-size:16px;cursor:pointer;">ç™»å½•</button>
        </div>
    </div>
    <!-- æ³¨å†Œå¼¹çª— -->
    <div id="registerModal" style="display:none;position:fixed;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);z-index:2000;align-items:center;justify-content:center;">
        <div style="background:#fff;border-radius:16px;max-width:320px;width:90vw;padding:24px;box-shadow:0 4px 24px #0002;position:relative;">
            <button type="button" aria-label="å…³é—­" onclick="document.getElementById('registerModal').style.display='none'" style="position:absolute;right:16px;top:8px;cursor:pointer;font-size:20px;background:none;border:none;">Ã—</button>
            <h2 style="text-align:center;color:#2a5d84;margin-bottom:18px;">æ³¨å†Œ</h2>
            <input type="text" id="registerUser" placeholder="ç”¨æˆ·å" style="width:100%;margin-bottom:12px;padding:8px;border-radius:8px;border:1px solid #b3d7e6;font-size:15px;">
            <input type="email" id="registerEmail" placeholder="é‚®ç®±" style="width:100%;margin-bottom:12px;padding:8px;border-radius:8px;border:1px solid #b3d7e6;font-size:15px;">
            <input type="password" id="registerPass" placeholder="å¯†ç " style="width:100%;margin-bottom:18px;padding:8px;border-radius:8px;border:1px solid #b3d7e6;font-size:15px;">
            <button id="registerSubmit" style="width:100%;background:#6bb6ff;color:#fff;border:none;border-radius:8px;padding:10px;font-size:16px;cursor:pointer;">æ³¨å†Œ</button>
        </div>
    </div>
    <div class="container">
        <img class="bottle-img" src="https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=400&q=80" alt="æ¼‚æµç“¶">
        <h1>æ¼‚æµç“¶é‡Œçš„ä¿¡</h1>
        <form id="bottleForm" autocomplete="off">
            <!-- åŒ¿åæŠ•é€’ ï¼ˆbushiï¼‰-->
            <label><input type="checkbox" id="anonymous" name="anonymous" style="margin-right:6px;">åŒ¿åæŠ•é€’</label>
            <br><br>
            <!-- ä¸»é¢˜çš®è‚¤åˆ‡æ¢ï¼ˆgoodï¼‰ -->
            <label for="theme">ä¸»é¢˜çš®è‚¤ï¼š</label>
            <select id="theme" name="theme" class="time-select" style="margin-bottom:16px;">
                <option value="ocean">æµ·æ´‹</option>
                <option value="night">å¤œç©º</option>
                <option value="forest">æ£®æ—</option>
                <option value="default" selected>é»˜è®¤</option>
            </select>
            <label for="recipient">æ”¶ä»¶äººæ˜µç§°/é‚®ç®±ï¼š</label>
            <input type="text" id="recipient" name="recipient" required placeholder="è¯·è¾“å…¥æ”¶ä»¶äººæ˜µç§°æˆ–é‚®ç®±" style="width:100%;margin-bottom:16px;padding:8px;border-radius:8px;border:1px solid #b3d7e6;font-size:15px;">
            <label for="type">ä¿¡ä»¶ç±»å‹ï¼š</label>
            <select id="type" name="type" class="time-select" style="margin-bottom:16px;">
                <option value="ç¥ç¦">ç¥ç¦</option>
                <option value="é¼“åŠ±">é¼“åŠ±</option>
                <option value="ç§˜å¯†">ç§˜å¯†</option>
                <option value="æ¢¦æƒ³">æ¢¦æƒ³</option>
                <option value="å…¶ä»–">å…¶ä»–</option>
            </select>
            <label for="letter">å†™ä¸€å°ä¿¡ï¼ˆç»™è‡ªå·±æˆ–ä»–äººï¼‰ï¼š</label>
            <textarea id="letter" name="letter" required maxlength="300" placeholder="åœ¨è¿™é‡Œå†™ä¸‹ä½ çš„å¿ƒé‡Œè¯â€¦â€¦" oninput="updateWordCount()"></textarea>
            <div id="wordCountWrap" style="text-align:right;color:#888;font-size:13px;margin-bottom:8px;">å­—æ•°ï¼š<span id="wordCount">0</span>/300</div>
            <label for="image">ä¸Šä¼ å›¾ç‰‡/è¡¨æƒ…ï¼š</label>
            <input type="file" id="image" name="image" accept="image/*" style="margin-bottom:16px;">
            <!-- è‡ªå®šä¹‰æ¼‚æµç“¶å›¾ç‰‡ï¼ˆè™½ç„¶ä¸ä¼šä¸Šä¼ ï¼‰ -->
            <label for="bottleImg">è‡ªå®šä¹‰æ¼‚æµç“¶å›¾ç‰‡ï¼š</label>
            <input type="file" id="bottleImg" accept="image/*" style="margin-bottom:16px;">
            <label for="voice">å½•åˆ¶è¯­éŸ³ç•™è¨€ï¼š</label>
            <button type="button" id="recordBtn" style="width:100%;margin-bottom:10px;">å¼€å§‹å½•éŸ³</button>
            <audio id="audioPreview" controls style="display:none;width:100%;margin-bottom:10px;"></audio>
            <label for="time">é€‰æ‹©æ”¶ä¿¡æ—¶é—´ï¼š</label>
            <select id="time" class="time-select" name="time">
                <option value="5">5å¹´å</option>
                <option value="10">10å¹´å</option>
                <option value="20">20å¹´å</option>
                <option value="30">30å¹´å</option>
                <option value="custom">è‡ªå®šä¹‰</option>
            </select>
            <input type="number" id="customTime" class="custom-time" min="1" max="100" placeholder="è¯·è¾“å…¥å¹´æ•°" />
            <label for="password">è®¾ç½®ä¿¡ä»¶å¯†ç ï¼ˆå¯é€‰ï¼‰ï¼š</label>
            <input type="password" id="password" name="password" placeholder="è®¾ç½®å¯†ç åä»…æ”¶ä»¶äººå¯æŸ¥çœ‹" style="width:100%;margin-bottom:16px;padding:8px;border-radius:8px;border:1px solid #b3d7e6;font-size:15px;">
            <label for="remind">åˆ°æœŸæé†’æ–¹å¼ï¼š</label>
            <select id="remind" name="remind" class="time-select" style="margin-bottom:16px;">
                <option value="none">ä¸æé†’</option>
                <option value="email">é‚®ä»¶æé†’</option>
                <option value="sms">çŸ­ä¿¡æé†’</option>
            </select>
            <input type="email" id="remindEmail" name="remindEmail" placeholder="è¯·è¾“å…¥é‚®ç®±åœ°å€" style="display:none;width:100%;margin-bottom:16px;padding:8px;border-radius:8px;border:1px solid #b3d7e6;font-size:15px;">
            <input type="tel" id="remindPhone" placeholder="è¯·è¾“å…¥æ‰‹æœºå·ç " style="display:none;width:100%;margin-bottom:16px;padding:8px;border-radius:8px;border:1px solid #b3d7e6;font-size:15px;">
            <!-- å‘é€å‰é¢„è§ˆ -->
            <button type="button" class="send-btn" id="previewBtn" style="background:#6bb6ff;margin-bottom:10px;">é¢„è§ˆä¿¡ä»¶</button>
            <button type="submit" class="send-btn">å‘é€æ¼‚æµç“¶</button>
        </form>
        <div class="success-message" id="successMsg" style="display:none;">æ¼‚æµç“¶å·²æŠ•å‡ºï¼ŒæœŸå¾…æœªæ¥çš„ä½ /TAæ”¶åˆ°ï¼</div>
        <!-- ç¥ç¦å¡ç‰‡é¢„è§ˆå¼¹çª— -->
        <div id="previewModal" style="display:none;position:fixed;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);z-index:999;align-items:center;justify-content:center;">
            <div style="background:#fff;border-radius:16px;max-width:350px;width:90vw;padding:24px;box-shadow:0 4px 24px #0002;position:relative;">
                <span id="closePreview" style="position:absolute;right:16px;top:8px;cursor:pointer;font-size:20px;">Ã—</span>
                <div id="previewContent"></div>
            </div>
        </div>
        <!-- äºŒç»´ç å±•ç¤º -->
        <div id="qrcode" style="display:none;text-align:center;margin-top:20px;"></div>
        <!-- åœ°å›¾å±•ç¤º -->
        <div id="bottleMap" style="display:none;text-align:center;margin-top:18px;"></div>
        <!-- å¤šè¯­è¨€åˆ‡æ¢ -->
        <div style="text-align:center;margin-top:18px;">
            <button id="langBtn" style="background:#eee;border:none;padding:6px 16px;border-radius:8px;cursor:pointer;">English</button>
        </div>
        <!-- å‘é€è¿›åº¦æ¡ -->
        <div id="progressBar" style="display:none;width:100%;height:8px;background:#eaf6fb;border-radius:8px;margin-top:10px;overflow:hidden;">
            <div id="progressInner" style="height:100%;width:0;background:#6bb6ff;"></div>
        </div>
        <!-- å‘é€å†å²è®°å½• -->
        <div id="history" style="margin-top:24px;"></div>
    </div>
    <!-- zip.js & smtp.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@zip.js/zip.js@2.7.28/dist/zip-full.min.js"></script>
    <script>
        // é‚®ç®±ç›¸å…³å˜é‡å®šä¹‰ï¼Œé˜²æ­¢æœªå®šä¹‰æŠ¥é”™
        const adminMail = "liujunkaiqianyuyouzhen@Outlook.com";
        const subject = "æ¼‚æµç“¶æŠ•é€’";
        const body = "è¯·æŸ¥æ”¶é™„ä»¶ï¼ˆæ¼‚æµç“¶zipæ–‡ä»¶ï¼‰";

        const timeSelect = document.getElementById('time');
        const customTime = document.getElementById('customTime');
        timeSelect.addEventListener('change', function() {
            if (this.value === 'custom') {
                customTime.style.display = 'block';
                customTime.required = true;
            } else {
                customTime.style.display = 'none';
                customTime.required = false;
            }
        });
        // è¯­éŸ³å½•åˆ¶åŠŸèƒ½
        let mediaRecorder, audioChunks = [];
        const recordBtn = document.getElementById('recordBtn');
        const audioPreview = document.getElementById('audioPreview');
        let isRecording = false;
        recordBtn.addEventListener('click', async function() {
            if (!isRecording) {
                if (!navigator.mediaDevices) {
                    alert('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒå½•éŸ³');
                    return;
                }
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new window.MediaRecorder(stream);
                    audioChunks = [];
                    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        const audioUrl = URL.createObjectURL(audioBlob);
                        audioPreview.src = audioUrl;
                        audioPreview.style.display = 'block';
                    };
                    mediaRecorder.start();
                    recordBtn.textContent = 'åœæ­¢å½•éŸ³';
                    isRecording = true;
                } catch (err) {
                    alert('æœªæ£€æµ‹åˆ°éº¦å…‹é£æˆ–æœªæˆæƒè®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥è®¾å¤‡å’Œæƒé™è®¾ç½®ã€‚');
                }
            } else {
                mediaRecorder.stop();
                recordBtn.textContent = 'å¼€å§‹å½•éŸ³';
                isRecording = false;
            }
        });
        // æ¼‚æµç“¶åœ°å›¾ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
        function showBottleMap() {
            const mapDiv = document.getElementById('bottleMap');
            mapDiv.style.display = 'flex';
            mapDiv.style.justifyContent = 'center';
            mapDiv.style.alignItems = 'center';
            mapDiv.innerHTML = `
                <div id="bottleMapInner" style="position:relative;width:320px;height:180px;background:#eaf6fb;border-radius:16px;box-shadow:0 4px 24px #0002;overflow:hidden;">
                    <img src='https://img.icons8.com/color/480/000000/world-map.png' alt='ä¸–ç•Œåœ°å›¾' style='width:100%;height:100%;object-fit:cover;filter:brightness(0.97) contrast(1.1);'>
                </div>
                <div style='margin-left:18px;display:flex;flex-direction:column;justify-content:center;'>
                    <span style='color:#2a5d84;font-size:15px;'>"${isEn ? langMap.en.map : langMap.zh.map}"</span>
                </div>
            `;
            // éšæœºç”Ÿæˆæ¼‚æµç“¶å›¾æ ‡
            const bottleIcon = 'https://img.icons8.com/emoji/48/000000/bottle-with-popping-cork.png';
            const mapInner = document.getElementById('bottleMapInner');
            const bottleCount = Math.floor(Math.random()*4)+3; // 3~6ä¸ª
            for(let i=0;i<bottleCount;i++){
                const x = Math.random()*260+10; // 10~270
                const y = Math.random()*120+10; // 10~130
                const img = document.createElement('img');
                img.src = bottleIcon;
                img.style.position = 'absolute';
                img.style.left = x+'px';
                img.style.top = y+'px';
                img.style.width = '28px';
                img.style.opacity = '0.92';
                img.style.transition = 'transform 0.8s cubic-bezier(.4,2,.6,1)';
                img.style.transform = 'scale(0.7)';
                setTimeout(()=>{img.style.transform='scale(1.1)';}, 100+Math.random()*600);
                setTimeout(()=>{img.style.transform='scale(1)';}, 800+Math.random()*600);
                mapInner.appendChild(img);
            }
        }
        // æŠ•é€’åŠ¨ç”»
        function playSendAnimation() {
            const img = document.querySelector('.bottle-img');
            img.animate([
                { transform: 'translateY(0)' },
                { transform: 'translateY(-40px) scale(1.2)' },
                { transform: 'translateY(100vh) scale(0.5)', opacity: 0 }
            ], {
                duration: 1200,
                easing: 'ease-in',
            });
        }
        // ä¸»é¢˜çš®è‚¤åˆ‡æ¢
        document.getElementById('theme').addEventListener('change', function() {
            const theme = this.value;
            if(theme==='ocean') document.body.style.background = 'linear-gradient(to bottom,#aee1f9 0%,#f9f9f9 100%)';
            else if(theme==='night') document.body.style.background = 'linear-gradient(to bottom,#232946 0%,#b8c1ec 100%)';
            else if(theme==='forest') document.body.style.background = 'linear-gradient(to bottom,#a8e6cf 0%,#f9f9f9 100%)';
            else document.body.style.background = 'linear-gradient(to bottom,#aee1f9 0%,#f9f9f9 100%)';
        });
        // å­—æ•°ç»Ÿè®¡
        function updateWordCount() {
            document.getElementById('wordCount').textContent = document.getElementById('letter').value.length;
        }
        // å¤šè¯­è¨€åˆ‡æ¢
        const langMap = {
            zh: {
                title: 'å°å°æ¼‚æµç“¶ï¼ˆroveråˆ¶ä½œï¼‰',
                h1: 'æ¼‚æµç“¶æ—¶å…‰ä¿¡',
                anonymous: 'åŒ¿åæŠ•é€’',
                theme: 'ä¸»é¢˜çš®è‚¤ï¼š',
                recipient: 'æ”¶ä»¶äººæ˜µç§°/é‚®ç®±ï¼š',
                type: 'ä¿¡ä»¶ç±»å‹ï¼š',
                typeOpts: ['ç¥ç¦','é¼“åŠ±','ç§˜å¯†','æ¢¦æƒ³','å…¶ä»–'],
                letter: 'å†™ä¸€å°ä¿¡ï¼ˆç»™è‡ªå·±æˆ–ä»–äººï¼‰ï¼š',
                wordCount: 'å­—æ•°',
                uploadImg: 'ä¸Šä¼ å›¾ç‰‡/è¡¨æƒ…ï¼š',
                customBottle: 'è‡ªå®šä¹‰æ¼‚æµç“¶å›¾ç‰‡ï¼š',
                record: 'å½•åˆ¶è¯­éŸ³ç•™è¨€ï¼š',
                time: 'é€‰æ‹©æ”¶ä¿¡æ—¶é—´ï¼š',
                timeOpts: ['5å¹´å','10å¹´å','20å¹´å','30å¹´å','è‡ªå®šä¹‰'],
                customTime: 'è¯·è¾“å…¥å¹´æ•°',
                password: 'è®¾ç½®ä¿¡ä»¶å¯†ç ï¼ˆå¯é€‰ï¼‰ï¼š',
                passwordPh: 'è®¾ç½®å¯†ç åä»…æ”¶ä»¶äººå¯æŸ¥çœ‹',
                remind: 'åˆ°æœŸæé†’æ–¹å¼ï¼š',
                remindOpts: ['ä¸æé†’','é‚®ä»¶æé†’','çŸ­ä¿¡æé†’'],
                preview: 'é¢„è§ˆä¿¡ä»¶',
                send: 'å‘é€æ¼‚æµç“¶',
                success: 'æ¼‚æµç“¶å·²æŠ•å‡ºï¼ŒæœŸå¾…æœªæ¥çš„ä½ /TAæ”¶åˆ°ï¼',
                history: 'å‘é€å†å²',
                bottleId: 'æ¼‚æµç“¶ç¼–å·ï¼š',
                progress: 'å‘é€ä¸­...',
                english: 'English',
                chinese: 'ä¸­æ–‡',
                map: 'ä½ çš„æ¼‚æµç“¶æ­£åœ¨ä¸–ç•Œå„åœ°æ¼‚æµ...'
            },
            en: {
                title: 'Drifting Bottle (by rover)',
                h1: 'Drifting Bottle Time Letter',
                anonymous: 'Send Anonymously',
                theme: 'Theme:',
                recipient: 'Recipient Nickname/Email:',
                type: 'Letter Type:',
                typeOpts: ['Blessing','Encouragement','Secret','Dream','Other'],
                letter: 'Write a letter (to yourself or others):',
                wordCount: 'Words',
                uploadImg: 'Upload Image/Emoji:',
                customBottle: 'Custom Bottle Image:',
                record: 'Record Voice Message:',
                time: 'Choose Delivery Time:',
                timeOpts: ['5 years later','10 years later','20 years later','30 years later','Custom'],
                customTime: 'Enter years',
                password: 'Set Letter Password (optional):',
                passwordPh: 'Only recipient can view with password',
                remind: 'Reminder:',
                remindOpts: ['No reminder','Email','SMS'],
                preview: 'Preview',
                send: 'Send Bottle',
                success: 'Bottle sent! Waiting for the future you/them to receive!',
                history: 'Sent History',
                bottleId: 'Bottle ID:',
                progress: 'Sending...',
                english: 'English',
                chinese: 'ä¸­æ–‡',
                map: 'Your bottle is drifting around the world...'
            }
        };
        let isEn = false;
        function setLang(en) {
            const lang = en ? langMap.en : langMap.zh;
            document.title = lang.title;
            document.querySelector('h1').textContent = lang.h1;
            // ä¿®å¤ nextSibling å¯èƒ½ä¸º null çš„é—®é¢˜
            const anonymousInput = document.getElementById('anonymous');
            let anonLabel = anonymousInput.parentNode;
            if (anonLabel && anonLabel.tagName === 'LABEL') {
                // ç›´æ¥è®¾ç½®labelçš„æœ€åæ–‡æœ¬èŠ‚ç‚¹
                let nodes = Array.from(anonLabel.childNodes);
                let textNode = nodes.find(n => n.nodeType === 3);
                if (textNode) {
                    textNode.nodeValue = lang.anonymous;
                } else {
                    anonLabel.appendChild(document.createTextNode(lang.anonymous));
                }
            }
            document.querySelector('label[for="theme"]').textContent = lang.theme;
            document.querySelector('label[for="recipient"]').textContent = lang.recipient;
            document.querySelector('label[for="type"]').textContent = lang.type;
            const typeSel = document.getElementById('type');
            typeSel.innerHTML = lang.typeOpts.map(t=>`<option value="${t}">${t}</option>`).join('');
            document.querySelector('label[for="letter"]').textContent = lang.letter;
            // ä¿®å¤å­—æ•°ç»Ÿè®¡åˆ‡æ¢è¯­è¨€æ—¶çš„æŠ¥é”™
            const wordCountWrap = document.getElementById('wordCountWrap');
            if (wordCountWrap) {
                wordCountWrap.innerHTML = lang.wordCount + 'ï¼š<span id="wordCount">' + document.getElementById('letter').value.length + '</span>/300';
            }
            document.querySelector('label[for="image"]').textContent = lang.uploadImg;
            document.querySelector('label[for="bottleImg"]').textContent = lang.customBottle;
            document.querySelector('label[for="voice"]').textContent = lang.record;
            document.querySelector('label[for="time"]').textContent = lang.time;
            const timeSel = document.getElementById('time');
            timeSel.innerHTML = lang.timeOpts.map((t,i)=>`<option value="${i<4?parseInt(t):'custom'}">${t}</option>`).join('');
            document.getElementById('customTime').placeholder = lang.customTime;
            document.querySelector('label[for="password"]').textContent = lang.password;
            document.getElementById('password').placeholder = lang.passwordPh;
            document.querySelector('label[for="remind"]').textContent = lang.remind;
            const remindSel = document.getElementById('remind');
            remindSel.innerHTML = lang.remindOpts.map((t,i)=>`<option value="${['none','email','sms'][i]}">${t}</option>`).join('');
            document.getElementById('previewBtn').textContent = lang.preview;
            document.querySelector('button[type="submit"]').textContent = lang.send;
            document.getElementById('successMsg').textContent = lang.success;
            document.getElementById('langBtn').textContent = en ? lang.chinese : lang.english;
            // å†å²ã€äºŒç»´ç ã€åœ°å›¾ç­‰å¯æŒ‰éœ€æ‰©å±•
        }
        document.getElementById('langBtn').onclick = function() {
            isEn = !isEn;
            setLang(isEn);
        };
        setLang(false);
        // åŒ¿åæŠ•é€’
        document.getElementById('anonymous').addEventListener('change',function(){
            document.getElementById('recipient').disabled = this.checked;
        });
        // å‘é€å‰é¢„è§ˆ
        document.getElementById('previewBtn').onclick = function(){
            let html = `<b>æ”¶ä»¶äººï¼š</b>${document.getElementById('anonymous').checked?'åŒ¿å':document.getElementById('recipient').value}<br>`;
            html += `<b>ç±»å‹ï¼š</b>${document.getElementById('type').value}<br>`;
            html += `<b>å†…å®¹ï¼š</b>${document.getElementById('letter').value}<br>`;
            html += `<b>æ”¶ä¿¡æ—¶é—´ï¼š</b>${document.getElementById('time').value==='custom'?document.getElementById('customTime').value+'å¹´å':document.getElementById('time').options[document.getElementById('time').selectedIndex].text}<br>`;
            html += `<b>æé†’ï¼š</b>${document.getElementById('remind').value}<br>`;
            if(document.getElementById('audioPreview').src) html += `<b>è¯­éŸ³ï¼š</b><audio src='${document.getElementById('audioPreview').src}' controls style='width:100%;'></audio><br>`;
            document.getElementById('previewContent').innerHTML = html;
            document.getElementById('previewModal').style.display = 'flex';
        };
        document.getElementById('closePreview').onclick = function(){
            document.getElementById('previewModal').style.display = 'none';
        };
        // å…è®¸è‡ªå®šä¹‰æ¼‚æµç“¶å›¾ç‰‡
        document.getElementById('bottleImg').addEventListener('change',function(e){
            const file = e.target.files[0];
            if(file){
                const reader = new FileReader();
                reader.onload = function(evt){
                    document.querySelector('.bottle-img').src = evt.target.result;
                };
                reader.readAsDataURL(file);
            }
        });
        // å‘é€å†å²è®°å½•æœ¬åœ°ä¿å­˜
        function saveHistory(data){
            let arr = JSON.parse(localStorage.getItem('bottleHistory')||'[]');
            arr.unshift(data);
            localStorage.setItem('bottleHistory',JSON.stringify(arr.slice(0,10)));
        }
        function renderHistory(){
            let arr = JSON.parse(localStorage.getItem('bottleHistory')||'[]');
            let likeMap = JSON.parse(localStorage.getItem('bottleLikes')||'{}');
            let likedSet = JSON.parse(localStorage.getItem('bottleLikedSet')||'[]');
            let html = '<h3 style="color:#2a5d84;">å‘é€å†å²</h3>';
            arr.forEach((item,i)=>{
                const likeCount = likeMap[item.id]||0;
                const liked = likedSet.includes(item.id);
                html += `<div style='background:#eaf6fb;border-radius:10px;padding:10px 15px;margin-bottom:10px;'>
                    <b>${item.time}</b> <span style='color:#888;'>${item.type}</span><br>${item.content.substring(0,20)}...<br><span style='font-size:12px;color:#aaa;'>${item.date}</span>
                    <div style='margin-top:6px;'>
                        <button class='like-btn' data-id='${item.id}' style='background:${liked ? '#ffb347':'#fff'};color:#2a5d84;border:1px solid #b3d7e6;border-radius:6px;padding:2px 12px;cursor:${liked?'not-allowed':'pointer'};font-size:14px;' ${liked?'disabled':''}>ğŸ‘ç‚¹èµ <span class='like-count'>${likeCount}</span></button>
                    </div>
                </div>`;
            });
            document.getElementById('history').innerHTML = html;
            // ç»‘å®šç‚¹èµäº‹ä»¶
            document.querySelectorAll('.like-btn').forEach(btn=>{
                btn.onclick = function(){
                    const id = this.getAttribute('data-id');
                    let likeMap = JSON.parse(localStorage.getItem('bottleLikes')||'{}');
                    let likedSet = JSON.parse(localStorage.getItem('bottleLikedSet')||'[]');
                    if(likedSet.includes(id)) return;
                    likeMap[id] = (likeMap[id]||0)+1;
                    likedSet.push(id);
                    localStorage.setItem('bottleLikes',JSON.stringify(likeMap));
                    localStorage.setItem('bottleLikedSet',JSON.stringify(likedSet));
                    renderHistory();
                };
            });
        }
        renderHistory();
        // å‘é€è¿›åº¦æ¡
        function showProgress(){
            document.getElementById('progressBar').style.display = 'block';
            let inner = document.getElementById('progressInner');
            inner.style.width = '0';
            let w = 0;
            let timer = setInterval(()=>{
                w+=10;
                inner.style.width = w+'%';
                if(w>=100){clearInterval(timer);}
            },80);
        }
        // å‘é€åç”ŸæˆäºŒç»´ç å’Œç¥ç¦å¡ç‰‡ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
        function showQRCode(id){
            // è·å–ä¸»è¦ä¿¡æ¯
            const type = document.getElementById('type').value;
            const recipient = document.getElementById('anonymous').checked ? (isEn ? 'Anonymous' : 'åŒ¿å') : document.getElementById('recipient').value;
            const content = document.getElementById('letter').value.substring(0, 20) + (document.getElementById('letter').value.length > 20 ? '...' : '');
            const time = document.getElementById('time').value === 'custom' ? document.getElementById('customTime').value + (isEn ? ' years later' : 'å¹´å') : document.getElementById('time').options[document.getElementById('time').selectedIndex].text;
            // ç»„è£…äºŒç»´ç å†…å®¹
            const qrData = {
                id,
                type,
                recipient,
                content,
                time
            };
            const qrStr = encodeURIComponent(JSON.stringify(qrData));
            const qrcodeDiv = document.getElementById('qrcode');
            qrcodeDiv.style.display = 'flex';
            qrcodeDiv.style.justifyContent = 'center';
            qrcodeDiv.innerHTML = `
                <div style="background:#fff;border-radius:18px;box-shadow:0 4px 24px #0002;padding:18px 18px 18px 18px;display:flex;flex-direction:column;align-items:center;max-width:280px;width:100%;box-sizing:border-box;margin:0 auto;">
                    <div style='color:#2a5d84;font-size:15px;margin-bottom:8px;word-break:break-all;'>${isEn ? langMap.en.bottleId : langMap.zh.bottleId}<b>${id}</b></div>
                    <div style='background:#eaf6fb;border-radius:12px;padding:10px 10px 6px 10px;box-shadow:0 2px 8px #0001;width:100%;display:flex;flex-direction:column;align-items:center;margin-bottom:12px;'>
                        <img id='qrImg' src='https://api.qrserver.com/v1/create-qr-code/?size=160x160&data=${qrStr}' alt='äºŒç»´ç ' style='width:160px;max-width:100%;height:auto;display:block;margin:0 auto;'>
                    </div>
                    <div id='cardPreviewWrap' style='width:100%;display:flex;flex-direction:column;align-items:center;'></div>
                    <button id='downloadQR' style='margin:16px 0 0 0;background:#6bb6ff;color:#fff;border:none;border-radius:8px;padding:6px 18px;font-size:15px;cursor:pointer;width:100%;max-width:180px;'>${isEn ? 'Download QR' : 'ä¸‹è½½äºŒç»´ç '}</button>
                </div>
            `;
            // ç¥ç¦å¡ç‰‡å›¾ç‰‡è¿½åŠ åˆ°äºŒç»´ç ä¸‹æ–¹ï¼Œå¹¶è‡ªé€‚åº”å®½åº¦ï¼ˆç«–ç‰ˆï¼‰
            const cardImg = document.querySelector('#qrcode img[alt="ç¥ç¦å¡ç‰‡"]');
            if(cardImg){
                cardImg.style.display = 'block';
                cardImg.style.maxWidth = '100%';
                cardImg.style.height = 'auto';
                cardImg.style.margin = '0 auto 0 auto';
                document.getElementById('cardPreviewWrap').appendChild(cardImg);
            }
            // ä¸‹è½½äºŒç»´ç åŠŸèƒ½
            document.getElementById('downloadQR').onclick = function(){
                const qr = document.getElementById('qrImg');
                const a = document.createElement('a');
                a.href = qr.src;
                a.download = `bottle_qr_${id}.png`;
                document.body.appendChild(a);
                a.click();
                a.remove();
            };
        }
        document.getElementById('bottleForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            showProgress();
            playSendAnimation();
            setTimeout(async () => {
                document.getElementById('successMsg').style.display = 'block';
                showBottleMap();
                // ç”Ÿæˆå”¯ä¸€ç¼–å·
                const bottleId = 'B'+Date.now()+Math.floor(Math.random()*1000);
                showQRCode(bottleId);
                // ä¿å­˜å†å²
                saveHistory({
                    id:bottleId,
                    type:document.getElementById('type').value,
                    content:document.getElementById('letter').value,
                    time:document.getElementById('time').value==='custom'?document.getElementById('customTime').value+'å¹´å':document.getElementById('time').options[document.getElementById('time').selectedIndex].text,
                    date:new Date().toLocaleString()
                });
                renderHistory();
                // ç”Ÿæˆç¥ç¦å¡ç‰‡å›¾ç‰‡ï¼ˆç®€å•å®ç°ï¼‰
                let card = document.createElement('canvas');
                card.width = 320; card.height = 180;
                let ctx = card.getContext('2d');
                ctx.fillStyle = '#aee1f9'; ctx.fillRect(0,0,320,180);
                ctx.fillStyle = '#2a5d84'; ctx.font = 'bold 18px Arial';
                ctx.fillText(document.getElementById('type').value,20,40);
                ctx.font = '15px Arial';
                ctx.fillText(document.getElementById('letter').value.substring(0,18)+'...',20,80);
                ctx.font = '12px Arial'; ctx.fillStyle = '#555';
                ctx.fillText('ç¼–å·:'+bottleId,20,160);
                let img = document.createElement('img');
                img.src = card.toDataURL();
                img.alt = 'ç¥ç¦å¡ç‰‡'; // å…³é”®ï¼šåŠ ä¸Šaltå±æ€§ï¼Œä¾¿äºåç»­æŸ¥æ‰¾
                // ä¼˜å…ˆæ’å…¥åˆ°äºŒç»´ç ä¸‹æ–¹çš„cardPreviewWrapåŒºåŸŸ
                const cardWrap = document.getElementById('cardPreviewWrap');
                if(cardWrap){
                    img.style.display = 'block';
                    img.style.maxWidth = '100%';
                    img.style.height = 'auto';
                    img.style.margin = '0 auto 0 auto';
                    cardWrap.appendChild(img);
                }else{
                    document.getElementById('qrcode').appendChild(img);
                }

                // --- æ‰“åŒ…zip ---
                const zipWriter = new zip.ZipWriter(new zip.BlobWriter("application/zip"));
                // æ–‡æœ¬å†…å®¹
                const remindType = document.getElementById('remind').value;
                const remindEmail = document.getElementById('remindEmail').value;
                const remindPhone = document.getElementById('remindPhone').value;
                let extraInfo = '';
                if(remindType === 'email') extraInfo = `\næé†’é‚®ç®±: ${remindEmail}`;
                if(remindType === 'sms') extraInfo = `\næé†’æ‰‹æœºå·: ${remindPhone}`;
                const letterContent = `ç¼–å·: ${bottleId}\nç±»å‹: ${document.getElementById('type').value}\næ”¶ä»¶äºº: ${document.getElementById('anonymous').checked?'åŒ¿å':document.getElementById('recipient').value}\nå†…å®¹: ${document.getElementById('letter').value}\næ”¶ä¿¡æ—¶é—´: ${document.getElementById('time').value==='custom'?document.getElementById('customTime').value+'å¹´å':document.getElementById('time').options[document.getElementById('time').selectedIndex].text}\næé†’: ${remindType}${extraInfo}`;
                // ç¡®ä¿æ¼‚æµç“¶å†…å®¹å†™å…¥zip
                await zipWriter.add('letter.txt', new zip.TextReader(letterContent));
                // æ–°å¢ï¼šå¦‚å·²ç™»å½•ï¼Œå†™å…¥user.txt
                const currentUser = localStorage.getItem('currentUser');
                if(currentUser) {
                    const userData = localStorage.getItem('user_' + currentUser);
                    if(userData) {
                        await zipWriter.add('user.txt', new zip.TextReader(userData));
                    }
                }
                // å›¾ç‰‡
                const imgFile = document.getElementById('image').files[0];
                let imgFileName = imgFile ? 'image' + (imgFile.type === 'image/png' ? '.png' : '.jpg') : '';
                if(imgFile) {
                    await zipWriter.add(imgFileName, new zip.BlobReader(imgFile));
                }
                // è¯­éŸ³
                if(audioPreview.src) {
                    const audioBlob = await fetch(audioPreview.src).then(r=>r.blob());
                    await zipWriter.add('voice.wav', new zip.BlobReader(audioBlob));
                }
                // ç¥ç¦å¡ç‰‡
                await zipWriter.add('card.png', new zip.BlobReader(await fetch(img.src).then(r=>r.blob())));
                // ç”ŸæˆzipåŒ…å†…çš„é¢„è§ˆhtmlï¼Œç¡®ä¿å†…å®¹å®Œæ•´
                let previewHtml = `<!DOCTYPE html><html lang=\"zh-cn\"><head><meta charset=\"UTF-8\"><title>æ¼‚æµç“¶é¢„è§ˆ</title></head><body><h2>ä¿¡ä»¶å†…å®¹</h2><pre>${letterContent}</pre>${imgFile ? `<h3>å›¾ç‰‡é™„ä»¶</h3><img src=\"${imgFileName}\" style=\"max-width:300px;\">` : '<p>æ— å›¾ç‰‡é™„ä»¶</p>'}</body></html>`;
                await zipWriter.add('preview.html', new zip.TextReader(previewHtml));
                // å¯†ç åŠ å¯†ï¼ˆå¯é€‰ï¼‰
                const pwd = document.getElementById('password').value;
                let zipBlob;
                if(pwd) {
                    zipBlob = await zipWriter.close({password: pwd});
                } else {
                    zipBlob = await zipWriter.close();
                }
                // ç”Ÿæˆzipæ–‡ä»¶ä¸‹è½½é“¾æ¥å¹¶ç¡®ä¿ä¸‹è½½å®Œæˆåå†å”¤èµ·é‚®ç®±
                const zipUrl = URL.createObjectURL(zipBlob);
                // ä½¿ç”¨æ›´å…¼å®¹çš„ä¸‹è½½æ–¹å¼
                if (window.navigator.msSaveOrOpenBlob) {
                    // å…¼å®¹IE/Edge
                    window.navigator.msSaveOrOpenBlob(zipBlob, `bottle_${bottleId}.zip`);
                    setTimeout(() => {
                        window.location.href = `mailto:${adminMail}?subject=${subject}&body=${body}`;
                        alert('å·²ä¸ºä½ ä¸‹è½½zipæ–‡ä»¶ï¼Œè¯·åœ¨é‚®ç®±ä¸­æ‰‹åŠ¨æ·»åŠ zipé™„ä»¶åå‘é€ï¼');
                    }, 500);
                } else {
                    const a = document.createElement('a');
                    a.href = zipUrl;
                    a.download = `bottle_${bottleId}.zip`;
                    document.body.appendChild(a);
                    a.click();
                    setTimeout(() => {
                        URL.revokeObjectURL(zipUrl);
                        a.remove();
                        window.location.href = `mailto:${adminMail}?subject=${subject}&body=${body}`;
                        alert('å·²ä¸ºä½ ä¸‹è½½zipæ–‡ä»¶ï¼Œè¯·åœ¨é‚®ç®±ä¸­æ‰‹åŠ¨æ·»åŠ zipé™„ä»¶åå‘é€ï¼');
                    }, 1200);
                }
            }, 1200);
            this.reset();
            customTime.style.display = 'none';
            audioPreview.style.display = 'none';
            document.getElementById('progressBar').style.display = 'none';
        });
        // blobè½¬base64
        async function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }
        // é€‰æ‹©æé†’æ–¹å¼æ—¶æ˜¾ç¤ºé‚®ç®±æˆ–æ‰‹æœºå·è¾“å…¥æ¡†
        document.getElementById('remind').addEventListener('change', function() {
            const emailInput = document.getElementById('remindEmail');
            const phoneInput = document.getElementById('remindPhone');
            if(this.value === 'email') {
                emailInput.style.display = 'block';
                emailInput.required = true;
                phoneInput.style.display = 'none';
                phoneInput.required = false;
            } else if(this.value === 'sms') {
                phoneInput.style.display = 'block';
                phoneInput.required = true;
                emailInput.style.display = 'none';
                emailInput.required = false;
            } else {
                emailInput.style.display = 'none';
                emailInput.required = false;
                phoneInput.style.display = 'none';
                phoneInput.required = false;
            }
        });
        // ç™»å½•æ³¨å†Œå¼¹çª—é€»è¾‘
        window.addEventListener('DOMContentLoaded', function() {
            const loginBtn = document.getElementById('loginBtn');
            const registerBtn = document.getElementById('registerBtn');
            const loginModal = document.getElementById('loginModal');
            const registerModal = document.getElementById('registerModal');
            // æ–°å¢ï¼šç¾è§‚çš„ç™»å½•çŠ¶æ€æ 
            let userBar = document.getElementById('userBar');
            if (!userBar) {
                userBar = document.createElement('div');
                userBar.id = 'userBar';
                userBar.style = 'position:fixed;top:24px;right:32px;z-index:1001;display:none;align-items:center;min-width:180px;';
                document.body.appendChild(userBar);
            }
            // çŠ¶æ€æ æ ·å¼
            const userBarStyle = `
                #userBar { transition:box-shadow 0.2s; box-shadow:0 2px 12px #0001; background:#fff; border-radius:16px; padding:8px 18px 8px 12px; display:flex; align-items:center; min-width:200px; }
                #userBar:hover { box-shadow:0 4px 24px #0002; }
                #userBar .avatar { width:36px; height:36px; border-radius:50%; background:#6bb6ff; color:#fff; display:flex; align-items:center; justify-content:center; font-size:18px; font-weight:bold; margin-right:12px; box-shadow:0 2px 8px #6bb6ff33; }
                #userBar .user-info { display:flex; flex-direction:column; margin-right:16px; }
                #userBar .user-info .name { color:#2a5d84; font-size:15px; font-weight:bold; }
                #userBar .user-info .email { color:#888; font-size:13px; }
                #userBar .user-menu { position:relative; }
                #userBar .menu-btn { background:none; border:none; color:#2a5d84; font-size:18px; cursor:pointer; padding:0 6px; }
                #userBar .dropdown { display:none; position:absolute; right:0; top:120%; background:#fff; box-shadow:0 4px 16px #0002; border-radius:10px; min-width:110px; overflow:hidden; z-index:10; }
                #userBar .dropdown button { width:100%; background:none; border:none; color:#2a5d84; font-size:15px; padding:10px 16px; text-align:left; cursor:pointer; transition:background 0.15s; }
                #userBar .dropdown button:hover { background:#f0f6fa; }
                #userBar .user-menu.open .dropdown { display:block; }
                @media (max-width:600px) { #userBar { right:8px; top:8px; padding:6px 8px 6px 8px; min-width:120px; } #userBar .user-info { display:none; } }
            `;
            if (!document.getElementById('userBarStyle')) {
                const style = document.createElement('style');
                style.id = 'userBarStyle';
                style.innerHTML = userBarStyle;
                document.head.appendChild(style);
            }
            function getUserInfo(username) {
                // å–æœ¬åœ°å­˜å‚¨çš„æ³¨å†Œä¿¡æ¯
                const data = localStorage.getItem('user_' + username);
                if (!data) return { user: username, email: '' };
                return JSON.parse(data);
            }
            function showUserBar(username) {
                const info = getUserInfo(username);
                const avatar = info.user ? info.user[0].toUpperCase() : '?';
                userBar.innerHTML = `
                    <div class="avatar">${avatar}</div>
                    <div class="user-info">
                        <span class="name">${info.user}</span>
                        <span class="email">${info.email || ''}</span>
                    </div>
                    <div class="user-menu" tabindex="0">
                        <button class="menu-btn" aria-label="æ›´å¤šæ“ä½œ">â‹®</button>
                        <div class="dropdown">
                            <button id="logoutBtn">é€€å‡ºç™»å½•</button>
                            <button disabled style="color:#bbb;">ä¸ªäººä¸­å¿ƒ(å¾…å¼€å‘)</button>
                        </div>
                    </div>
                `;
                userBar.style.display = 'flex';
                document.getElementById('loginBtn').style.display = 'none';
                document.getElementById('registerBtn').style.display = 'none';
                // èœå•äº¤äº’
                const menu = userBar.querySelector('.user-menu');
                const menuBtn = userBar.querySelector('.menu-btn');
                menuBtn.onclick = function(e) {
                    e.stopPropagation();
                    menu.classList.toggle('open');
                };
                menu.onblur = function() { menu.classList.remove('open'); };
                document.addEventListener('click', function(ev) {
                    if (!menu.contains(ev.target)) menu.classList.remove('open');
                });
                // é€€å‡ºç™»å½•
                userBar.querySelector('#logoutBtn').onclick = function() {
                    localStorage.removeItem('currentUser');
                    userBar.style.display = 'none';
                    document.getElementById('loginBtn').style.display = '';
                    document.getElementById('registerBtn').style.display = '';
                };
            }
            // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
            const currentUser = localStorage.getItem('currentUser');
            if(currentUser) {
                showUserBar(currentUser);
            }
            if(loginBtn && loginModal) {
                loginBtn.onclick = () => {
                    loginModal.style.display = 'flex';
                    if(userBar) userBar.style.display = 'none';
                };
            }
            if(registerBtn && registerModal) {
                registerBtn.onclick = () => {
                    registerModal.style.display = 'flex';
                    if(userBar) userBar.style.display = 'none';
                };
            }
            // å¼¹çª—å…³é—­æ—¶æ¢å¤userBar
            document.querySelectorAll('#loginModal button[aria-label],#registerModal button[aria-label]').forEach(btn => {
                btn.addEventListener('click', function() {
                    const currentUser = localStorage.getItem('currentUser');
                    if(currentUser && userBar) userBar.style.display = 'flex';
                });
            });
            // ç®€å•çš„æœ¬åœ°å­˜å‚¨æ³¨å†Œ/ç™»å½•ï¼ˆä»…æ¼”ç¤ºï¼Œå®é™…è¯·ç”¨åç«¯éªŒè¯ï¼‰
            const registerSubmit = document.getElementById('registerSubmit');
            if(registerSubmit) {
                registerSubmit.onclick = function() {
                    const user = document.getElementById('registerUser').value.trim();
                    const email = document.getElementById('registerEmail').value.trim();
                    const pass = document.getElementById('registerPass').value;
                    if(!user || !email || !pass) { alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯'); return; }
                    localStorage.setItem('user_'+user, JSON.stringify({user, email, pass}));
                    alert('æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•ï¼');
                    registerModal.style.display = 'none';
                };
            }
            const loginSubmit = document.getElementById('loginSubmit');
            if(loginSubmit) {
                loginSubmit.onclick = function() {
                    const input = document.getElementById('loginUser').value.trim();
                    const pass = document.getElementById('loginPass').value;
                    let foundUser = null;
                    // éå†localStorageæŸ¥æ‰¾ç”¨æˆ·åæˆ–é‚®ç®±
                    for(let i=0;i<localStorage.length;i++){
                        const key = localStorage.key(i);
                        if(key.startsWith('user_')){
                            const info = JSON.parse(localStorage.getItem(key));
                            if(info.user === input || info.email === input){
                                foundUser = info;
                                break;
                            }
                        }
                    }
                    if(!foundUser) { alert('ç”¨æˆ·ä¸å­˜åœ¨'); return; }
                    if(foundUser.pass !== pass) { alert('å¯†ç é”™è¯¯'); return; }
                    alert('ç™»å½•æˆåŠŸï¼Œæ¬¢è¿ '+foundUser.user+'ï¼');
                    loginModal.style.display = 'none';
                    localStorage.setItem('currentUser', foundUser.user);
                    showUserBar(foundUser.user);
                };
            }
        });
    </script>
</body>
</html>